<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Connexion Supabase - Produits</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #8B4513; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #8B4513;
            border-radius: 5px;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
        button {
            background: #8B4513;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #D2691E;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .product-card {
            display: inline-block;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            text-align: center;
            min-width: 200px;
        }
        .product-icon { font-size: 3rem; }
        .loading {
            display: inline-block;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Connexion Supabase - Produits</h1>
        <p>Cette page teste la connexion √† Supabase et l'affichage des produits.</p>

        <!-- Test 1: Connexion -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ Test de Connexion Supabase</h2>
            <button onclick="testConnection()">Tester la connexion</button>
            <div id="connection-result"></div>
        </div>

        <!-- Test 2: Cat√©gories -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ Test de Chargement des Cat√©gories</h2>
            <button onclick="testCategories()">Charger les cat√©gories</button>
            <div id="categories-result"></div>
        </div>

        <!-- Test 3: Produits -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ Test de Chargement des Produits</h2>
            <button onclick="testProducts()">Charger les produits</button>
            <div id="products-result"></div>
        </div>

        <!-- Test 4: Produits par cat√©gorie -->
        <div class="test-section">
            <h2>4Ô∏è‚É£ Test par Cat√©gorie</h2>
            <button onclick="testProductsByCategory('pains-base')">Pains de base</button>
            <button onclick="testProductsByCategory('viennoiseries')">Viennoiseries</button>
            <button onclick="testProductsByCategory('sans-gluten')">Sans gluten</button>
            <div id="category-result"></div>
        </div>

        <!-- Test 5: Produits vedettes -->
        <div class="test-section">
            <h2>5Ô∏è‚É£ Test Produits Vedettes</h2>
            <button onclick="testFeaturedProducts()">Charger les vedettes</button>
            <div id="featured-result"></div>
        </div>

        <!-- Console de log -->
        <div class="test-section">
            <h2>üìã Console de log</h2>
            <button onclick="clearConsole()">Effacer</button>
            <pre id="console-log"></pre>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Scripts de test -->
    <script type="module">
        import dbConnection from '../js/config/database.js';
        import productService from '../js/services/productService.js';
        import categoryService from '../js/services/categoryService.js';

        let logMessages = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            const logMessage = `[${timestamp}] ${prefix} ${message}`;
            logMessages.push(logMessage);
            document.getElementById('console-log').textContent = logMessages.join('\n');
            console.log(logMessage);
        }

        window.clearConsole = function() {
            logMessages = [];
            document.getElementById('console-log').textContent = '';
        }

        // Test 1: Connexion
        window.testConnection = async function() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<div class="loading"></div> Test en cours...';
            
            try {
                log('Initialisation de la connexion Supabase...');
                await dbConnection.init();
                
                log('V√©rification de la connexion...');
                const isConnected = await dbConnection.checkConnection();
                
                if (isConnected) {
                    resultDiv.innerHTML = '<p class="success">‚úÖ Connexion r√©ussie!</p>';
                    log('Connexion Supabase r√©ussie', 'success');
                } else {
                    resultDiv.innerHTML = '<p class="error">‚ùå √âchec de connexion</p>';
                    log('√âchec de connexion Supabase', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                log(`Erreur de connexion: ${error.message}`, 'error');
            }
        }

        // Test 2: Cat√©gories
        window.testCategories = async function() {
            const resultDiv = document.getElementById('categories-result');
            resultDiv.innerHTML = '<div class="loading"></div> Chargement...';
            
            try {
                await dbConnection.init();
                log('Chargement des cat√©gories...');
                
                const categories = await categoryService.getAllCategories();
                
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ ${categories.length} cat√©gories charg√©es</p>
                    <pre>${JSON.stringify(categories, null, 2)}</pre>
                `;
                log(`${categories.length} cat√©gories charg√©es`, 'success');
                
                categories.forEach(cat => {
                    log(`  - ${cat.icon} ${cat.NameFR} (${cat.id})`);
                });
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                log(`Erreur chargement cat√©gories: ${error.message}`, 'error');
            }
        }

        // Test 3: Produits
        window.testProducts = async function() {
            const resultDiv = document.getElementById('products-result');
            resultDiv.innerHTML = '<div class="loading"></div> Chargement...';
            
            try {
                await dbConnection.init();
                log('Chargement de tous les produits...');
                
                const products = await productService.getAllProducts();
                
                let html = `<p class="success">‚úÖ ${products.length} produits charg√©s</p>`;
                html += '<div style="max-height: 400px; overflow-y: auto;">';
                
                products.forEach(product => {
                    html += `
                        <div class="product-card">
                            <div class="product-icon">${product.icon}</div>
                            <h4>${product.title_fr}</h4>
                            <p style="font-size: 0.9em; color: #666;">${product.code}</p>
                            <p style="font-size: 1.2em; color: #8B4513; font-weight: bold;">
                                ${product.price.toFixed(2)} ${product.currency}
                            </p>
                            ${product.featured ? '<span style="color: gold;">‚≠ê Vedette</span>' : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
                log(`${products.length} produits charg√©s`, 'success');
                
                // Stats par cat√©gorie
                const byCategory = {};
                products.forEach(p => {
                    byCategory[p.categoryId] = (byCategory[p.categoryId] || 0) + 1;
                });
                
                log('R√©partition par cat√©gorie:');
                Object.entries(byCategory).forEach(([cat, count]) => {
                    log(`  - ${cat}: ${count} produits`);
                });
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                log(`Erreur chargement produits: ${error.message}`, 'error');
            }
        }

        // Test 4: Produits par cat√©gorie
        window.testProductsByCategory = async function(categoryId) {
            const resultDiv = document.getElementById('category-result');
            resultDiv.innerHTML = '<div class="loading"></div> Chargement...';
            
            try {
                await dbConnection.init();
                log(`Chargement des produits de la cat√©gorie: ${categoryId}...`);
                
                const products = await productService.getProductsByCategory(categoryId);
                
                let html = `<p class="success">‚úÖ ${products.length} produits dans "${categoryId}"</p>`;
                html += '<div>';
                
                products.forEach(product => {
                    html += `
                        <div class="product-card">
                            <div class="product-icon">${product.icon}</div>
                            <h4>${product.title_fr}</h4>
                            <p style="font-size: 1.2em; color: #8B4513; font-weight: bold;">
                                ${product.price.toFixed(2)} ${product.currency}
                            </p>
                        </div>
                    `;
                });
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
                log(`${products.length} produits trouv√©s dans ${categoryId}`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                log(`Erreur chargement cat√©gorie: ${error.message}`, 'error');
            }
        }

        // Test 5: Produits vedettes
        window.testFeaturedProducts = async function() {
            const resultDiv = document.getElementById('featured-result');
            resultDiv.innerHTML = '<div class="loading"></div> Chargement...';
            
            try {
                await dbConnection.init();
                log('Chargement des produits vedettes...');
                
                const products = await productService.getFeaturedProducts();
                
                let html = `<p class="success">‚úÖ ${products.length} produits vedettes</p>`;
                html += '<div>';
                
                products.forEach(product => {
                    html += `
                        <div class="product-card" style="border-color: gold;">
                            <div class="product-icon">${product.icon}</div>
                            <span style="color: gold; font-size: 1.5em;">‚≠ê</span>
                            <h4>${product.title_fr}</h4>
                            <p style="font-size: 1.2em; color: #8B4513; font-weight: bold;">
                                ${product.price.toFixed(2)} ${product.currency}
                            </p>
                        </div>
                    `;
                });
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
                log(`${products.length} produits vedettes trouv√©s`, 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                log(`Erreur chargement vedettes: ${error.message}`, 'error');
            }
        }

        // Auto-test au chargement
        window.addEventListener('DOMContentLoaded', () => {
            log('Page de test charg√©e');
            log('Cliquez sur les boutons pour tester les fonctionnalit√©s');
        });
    </script>
</body>
</html>
