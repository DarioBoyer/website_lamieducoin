# Intégration Supabase pour les Commandes

## Vue d'ensemble

Ce document explique comment le système de commandes est intégré avec Supabase pour créer et stocker les commandes en ligne.

## Architecture

### Fichiers principaux

1. **order-service.js** - Service de gestion des commandes avec Supabase
2. **checkout.js** - Gestion du processus de checkout et création des commandes
3. **cart.js** - Gestion du panier d'achat
4. **commandes.html** - Page de commandes principale

## Configuration Supabase

### Connexion
```javascript
URL: https://mtuimnyoimiqhuyidyjv.supabase.co
Clé publique: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Schéma de base de données

#### Table `Orders`
```sql
create table public."Orders" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  "GuidId" character varying not null default ''::character varying,
  "customerLastName" character varying not null default ''::character varying,
  "customerFirstName" character varying not null default ''::character varying,
  email character varying null,
  phone character varying null,
  "phoneIsMobile" boolean null,
  language character varying null default 'FR'::character varying,
  "orderNote" text null,
  "totalAmount" real null default '0'::real,
  status character varying null default 'New'::character varying,
  "scheduledOn" date null,
  "deliveryDate" date null,
  deposit real null default '0'::real,
  paid boolean null default false,
  constraint Orders_pkey primary key (id),
  constraint Orders_GuidId_key unique ("GuidId")
);
```

#### Table `OrdersLines`
```sql
create table public."OrdersLines" (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  "orderId" bigint not null,
  "productId" bigint not null,
  "quantityOrdered" integer not null default 0,
  "quantityProduced" integer not null default 0,
  price real not null default '0'::real,
  "lineTotal" real not null default '0'::real,
  "lineStatus" character varying not null default 'ToDo'::character varying,
  "scheduledOn" date null,
  constraint OrdersLines_pkey primary key (id),
  constraint OrdersLines_orderId_fkey foreign key ("orderId") references "Orders" (id) on delete CASCADE,
  constraint OrdersLines_productId_fkey foreign key ("productId") references "Products" (id)
);
```

## Flux de création de commande

### 1. Le client ajoute des produits au panier
```javascript
cart.addItem(productId, quantity);
```

### 2. Le client clique sur "Passer la commande"
- Ouvre le modal de checkout via `openCheckout()`
- Affiche le résumé de la commande
- Demande les informations du client

### 3. Le client remplit le formulaire
- Prénom et nom (obligatoires)
- Email (obligatoire, validé)
- Téléphone (obligatoire, validé)
- Date de livraison souhaitée (optionnelle)
- Note de commande (optionnelle)

### 4. Validation du formulaire
```javascript
- Vérification des champs obligatoires
- Validation de l'email (regex)
- Validation du téléphone (format québécois)
```

### 5. Création de la commande dans Supabase
```javascript
const result = await orderService.createOrder({
  customerFirstName: 'Jean',
  customerLastName: 'Dupont',
  email: 'jean@example.com',
  phone: '514-555-1234',
  orderNote: 'Note optionnelle',
  deliveryDate: '2025-10-30',
  language: 'FR',
  orderLines: [
    {
      productId: 'pain-blanc',
      quantityOrdered: 2,
      price: 4.50
    }
  ]
});
```

### 6. Processus d'insertion

#### a) Création de la commande principale
```javascript
const orderRecord = {
  GuidId: '550e8400-e29b-41d4-a716-446655440000', // GUID généré
  customerFirstName: 'Jean',
  customerLastName: 'Dupont',
  email: 'jean@example.com',
  phone: '514-555-1234',
  phoneIsMobile: true,
  language: 'FR',
  orderNote: 'Note optionnelle',
  totalAmount: 9.00,
  status: 'New',
  deliveryDate: '2025-10-30',
  deposit: 0,
  paid: false
};

// Insertion dans Supabase
const { data: order } = await client
  .from('Orders')
  .insert([orderRecord])
  .select()
  .single();
```

#### b) Création des lignes de commande
```javascript
const orderLines = [
  {
    orderId: order.id, // ID de la commande créée
    productId: 1, // ID numérique du produit dans Supabase
    quantityOrdered: 2,
    quantityProduced: 0,
    price: 4.50,
    lineTotal: 9.00,
    lineStatus: 'ToDo'
  }
];

// Insertion dans Supabase
const { data: lines } = await client
  .from('OrdersLines')
  .insert(orderLines)
  .select();
```

### 7. Affichage de la confirmation
- Vider le panier
- Fermer le modal de checkout
- Afficher le modal de succès avec :
  - Numéro de commande
  - GUID de suivi
  - Email de confirmation
  - Lien vers le suivi de commande

## Mapping des produits

Le système utilise un mapping entre les codes de produits (chaînes) et les IDs numériques de Supabase :

```javascript
const productMapping = {
  'pain-blanc': 1,
  'baguette': 2,
  'pain-campagne': 3,
  'pain-noix': 4,
  'pain-fromage': 5,
  'croissant': 6,
  'brioche': 7,
  'pain-chocolat': 8,
  'bagel': 9,
  'bretzel': 10,
  'pain-sg-classique': 11,
  'focaccia': 12
};
```

## Statuts des commandes

### Statuts de commande (Orders.status)
- **New** : Nouvelle commande reçue
- **Plan** : Planifiée pour production
- **Production** : En cours de production
- **Completed** : Terminée, prête pour récupération
- **Done** : Récupérée par le client
- **Cancel** : Annulée

### Statuts de ligne (OrdersLines.lineStatus)
- **ToDo** : À faire
- **Plan** : Planifiée
- **Production** : En production
- **Completed** : Complétée

## Gestion des erreurs

Le système gère plusieurs types d'erreurs :

### Erreurs de validation
```javascript
- Champs obligatoires manquants
- Format d'email invalide
- Format de téléphone invalide
```

### Erreurs de connexion
```javascript
- Bibliothèque Supabase non chargée
- Échec de l'initialisation du client
- Erreur de connexion réseau
```

### Erreurs d'insertion
```javascript
- Erreur lors de l'insertion de la commande
- Erreur lors de l'insertion des lignes
- Violation de contraintes de clé étrangère
```

## Dépendances

### Scripts requis (dans l'ordre)
```html
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Custom JS -->
<script src="../js/utils.js"></script>
<script src="../js/main.js"></script>
<script src="../js/order-service.js"></script>
<script src="../js/order-manager.js"></script>
<script src="../js/cart.js"></script>
<script src="../js/orders-display.js"></script>
<script src="../js/checkout.js"></script>
```

## Fonctionnalités futures

### À implémenter
- [ ] Envoi d'email de confirmation automatique
- [ ] Système de paiement en ligne
- [ ] Calcul automatique de dépôt (25% du total)
- [ ] Notification SMS pour les mises à jour de statut
- [ ] Historique de commandes pour les clients
- [ ] Gestion des allergies et restrictions alimentaires

### Améliorations possibles
- [ ] Validation côté serveur (Supabase Edge Functions)
- [ ] Authentification des clients (Supabase Auth)
- [ ] Système de fidélité
- [ ] Recommandations de produits
- [ ] Calendrier de disponibilité des produits

## Support

Pour toute question ou problème, consultez :
- Documentation Supabase : https://supabase.com/docs
- Code source : voir les fichiers JS mentionnés ci-dessus

## Licence

© 2025 La mie du coin. Tous droits réservés.
