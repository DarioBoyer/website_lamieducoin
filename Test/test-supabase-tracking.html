<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase - Suivi de commande</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="mb-4">üß™ Test Supabase - Syst√®me de commandes</h1>
        
        <div class="alert alert-info">
            <strong>Instructions :</strong> Ce test v√©rifie que la connexion Supabase fonctionne et que les donn√©es sont correctement structur√©es.
        </div>

        <div class="mb-3">
            <button onclick="runTests()" class="btn btn-primary">‚ñ∂Ô∏è Lancer les tests</button>
            <button onclick="clearResults()" class="btn btn-secondary">üóëÔ∏è Effacer les r√©sultats</button>
        </div>

        <div id="test-results"></div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://mtuimnyoimiqhuyidyjv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10dWltbnlvaW1pcWh1eWlkeWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNjc3NjksImV4cCI6MjA3Njg0Mzc2OX0.SuB-0Kwaakff6pbZhKgWbGaAfL9h_NWaRBR9rNnaMIw';
        
        let supabaseClient;
        let resultsContainer;

        function initSupabase() {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                return true;
            } catch (error) {
                return false;
            }
        }

        function addResult(type, title, message, data = null) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            
            let html = `<h5>${title}</h5><p>${message}</p>`;
            
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            div.innerHTML = html;
            resultsContainer.appendChild(div);
        }

        async function runTests() {
            resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = '<h3>üîç R√©sultats des tests</h3>';

            // Test 1: Initialisation Supabase
            addResult('info', 'Test 1: Initialisation Supabase', 'Tentative d\'initialisation...');
            if (initSupabase()) {
                addResult('success', '‚úÖ Test 1 r√©ussi', 'Client Supabase initialis√© avec succ√®s');
            } else {
                addResult('error', '‚ùå Test 1 √©chou√©', 'Impossible d\'initialiser le client Supabase');
                return;
            }

            // Test 2: V√©rifier la table Products
            addResult('info', 'Test 2: Table Products', 'V√©rification de la structure...');
            try {
                const { data: products, error } = await supabaseClient
                    .from('Products')
                    .select('id, code, title_fr, title_en, icon, price')
                    .limit(5);

                if (error) throw error;

                if (products && products.length > 0) {
                    addResult('success', '‚úÖ Test 2 r√©ussi', `${products.length} produits trouv√©s`, products);
                    
                    // V√©rifier les colonnes bilingues
                    const firstProduct = products[0];
                    if (firstProduct.title_fr && firstProduct.title_en) {
                        addResult('success', '‚úÖ Colonnes bilingues OK', 'Les colonnes title_fr et title_en existent');
                    } else {
                        addResult('error', '‚ö†Ô∏è Colonnes bilingues manquantes', 'Les colonnes title_fr ou title_en sont vides. Voir CONFIGURATION-BDD-SUIVI-COMMANDES.md');
                    }
                } else {
                    addResult('error', '‚ö†Ô∏è Aucun produit trouv√©', 'La table Products est vide');
                }
            } catch (error) {
                addResult('error', '‚ùå Test 2 √©chou√©', error.message);
            }

            // Test 3: V√©rifier la table Orders
            addResult('info', 'Test 3: Table Orders', 'V√©rification des commandes...');
            try {
                const { data: orders, error } = await supabaseClient
                    .from('Orders')
                    .select('id, GuidId, customerFirstName, customerLastName, status, totalAmount, created_at')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                if (orders && orders.length > 0) {
                    addResult('success', '‚úÖ Test 3 r√©ussi', `${orders.length} commandes trouv√©es`, orders);
                    
                    // Tester avec la premi√®re commande
                    window.testOrderGuid = orders[0].GuidId;
                    addResult('info', 'üìã GUID de test', `Utilisez ce GUID pour tester le suivi: ${orders[0].GuidId}`);
                } else {
                    addResult('info', '‚ö†Ô∏è Aucune commande', 'Aucune commande n\'a encore √©t√© cr√©√©e. Cr√©ez une commande sur la page commandes.html');
                }
            } catch (error) {
                addResult('error', '‚ùå Test 3 √©chou√©', error.message);
            }

            // Test 4: V√©rifier la table OrdersLines
            addResult('info', 'Test 4: Table OrdersLines', 'V√©rification des lignes de commande...');
            try {
                const { data: lines, error } = await supabaseClient
                    .from('OrdersLines')
                    .select(`
                        id, orderId, productId, quantityOrdered, price, lineTotal,
                        Products (id, code, title_fr, title_en)
                    `)
                    .limit(5);

                if (error) throw error;

                if (lines && lines.length > 0) {
                    addResult('success', '‚úÖ Test 4 r√©ussi', `${lines.length} lignes de commande trouv√©es`, lines);
                    
                    // V√©rifier la relation avec Products
                    const hasProducts = lines.some(line => line.Products !== null);
                    if (hasProducts) {
                        addResult('success', '‚úÖ Relation Products OK', 'Les lignes sont correctement li√©es aux produits');
                    } else {
                        addResult('error', '‚ö†Ô∏è Relation Products manquante', 'Les productId ne correspondent pas aux IDs dans Products');
                    }
                } else {
                    addResult('info', '‚ö†Ô∏è Aucune ligne de commande', 'Aucune ligne de commande trouv√©e');
                }
            } catch (error) {
                addResult('error', '‚ùå Test 4 √©chou√©', error.message);
            }

            // Test 5: Test de r√©cup√©ration compl√®te (simulation du suivi)
            if (window.testOrderGuid) {
                addResult('info', 'Test 5: R√©cup√©ration compl√®te', 'Simulation du suivi de commande...');
                try {
                    // R√©cup√©rer la commande
                    const { data: order, error: orderError } = await supabaseClient
                        .from('Orders')
                        .select('*')
                        .eq('GuidId', window.testOrderGuid)
                        .single();

                    if (orderError) throw orderError;

                    // R√©cup√©rer les lignes
                    const { data: orderLines, error: linesError } = await supabaseClient
                        .from('OrdersLines')
                        .select(`
                            *,
                            Products (
                                id, code, title_fr, title_en,
                                description_fr, description_en, icon, price
                            )
                        `)
                        .eq('orderId', order.id);

                    if (linesError) throw linesError;

                    addResult('success', '‚úÖ Test 5 r√©ussi', 'Donn√©es compl√®tes r√©cup√©r√©es avec succ√®s', {
                        order: order,
                        orderLines: orderLines
                    });

                    // G√©n√©rer le lien de suivi
                    const trackingUrl = `${window.location.origin}/pages/suivi-commande.html?order=${window.testOrderGuid}`;
                    addResult('success', 'üîó Lien de suivi', `<a href="${trackingUrl}" target="_blank">${trackingUrl}</a>`);

                } catch (error) {
                    addResult('error', '‚ùå Test 5 √©chou√©', error.message);
                }
            }

            // R√©sum√© final
            const successCount = document.querySelectorAll('.test-result.success').length;
            const errorCount = document.querySelectorAll('.test-result.error').length;
            
            addResult(
                errorCount === 0 ? 'success' : 'info',
                'üìä R√©sum√©',
                `${successCount} tests r√©ussis, ${errorCount} erreurs`
            );
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>
